<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <meta http-equiv="X-UA-Compatible" content="IE=edge" >
  <title>使用webpack4提升180%编译速度 | louis blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="webpack4 使用webpack4提升180%编译速度">
<meta property="og:type" content="article">
<meta property="og:title" content="使用webpack4提升180%编译速度">
<meta property="og:url" content="http://louiszhai.github.io/2019/01/04/webpack4/index.html">
<meta property="og:site_name" content="louis blog">
<meta property="og:description" content="webpack4 使用webpack4提升180%编译速度">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-logo.gif">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-0-happyPack-0-dll-0-parallel.3~4.png">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-ParallelUglify.png">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-0-happyPack-0-dll-1-parallel.3~4.png">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-happyPack.gif">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-1-happyPack-0-dll-1-parallel.w4.png">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-1-happyPack-1-dll-1-parallel.w4.png">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-analyzer.png">
<meta property="og:image" content="http://louiszhai.github.io/docImages/webpack-analyzer.size.png">
<meta property="article:published_time" content="2019-01-04T02:49:08.000Z">
<meta property="article:modified_time" content="2019-12-02T03:28:32.899Z">
<meta property="article:author" content="路易斯">
<meta property="article:tag" content="Tool">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://louiszhai.github.io/docImages/webpack-logo.gif">
  
    <link rel="alternative" href="/atom.xml" title="louis blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 6.3.0"></head>

<body>
<div id="container">
    <div class="left-col">
        <div class="overlay">
	<!--<input type="text" class="st-default-search-input" style="position:absolute;top: 50px;left: 35px;">-->
</div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="https://avatars2.githubusercontent.com/u/8412301?v=3&amp;s=320" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">路易斯</a></h1>
		</hgroup>

		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>Menu</li>
						<li>Tags</li>
						
						<li>Links</li>
						
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">主页</a></li>
				        
							<li><a href="/archives/">所有文章</a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/Louiszhai" title="github">github</a>
					        
								<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/CSS/" style="font-size: 16.67px;">CSS</a> <a href="/tags/JavaScript/" style="font-size: 20px;">JavaScript</a> <a href="/tags/JavaScript-Canvas/" style="font-size: 10px;">JavaScript Canvas</a> <a href="/tags/JavaScript-Chrome-Extension/" style="font-size: 10px;">JavaScript Chrome-Extension</a> <a href="/tags/Tool/" style="font-size: 16.67px;">Tool</a> <a href="/tags/Web/" style="font-size: 16.67px;">Web</a> <a href="/tags/XSS/" style="font-size: 10px;">XSS</a> <a href="/tags/css/" style="font-size: 13.33px;">css</a> <a href="/tags/javascript/" style="font-size: 10px;">javascript</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.ruanyifeng.com/blog/">阮一峰的网络日志</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.zhangxinxu.com/wordpress/category/js/">张鑫旭-鑫空间-鑫生活</a>
			        
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://evanyou.me/">尤雨溪主页</a>
			        
			        </div>
				</section>
				

				
			</div>
		</div>
	</header>				
</div>

    </div>
    <div class="mid-col">
        <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">路易斯</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
			
				<img lazy-src="https://avatars2.githubusercontent.com/u/8412301?v=3&amp;s=320" class="js-avatar">
			
			</div>
			<hgroup>
			  <h1 class="header-author">路易斯</h1>
			</hgroup>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">主页</a></li>
		        
					<li><a href="/archives/">所有文章</a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/Louiszhai" title="github">github</a>
			        
						<a class="rss" target="_blank" href="/atom.xml" title="rss">rss</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>

        <div class="body-wrap"><article id="post-webpack4" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2019/01/04/webpack4/" class="article-date">
  	<time datetime="2019-01-04T02:49:08.000Z" itemprop="datePublished">2019-01-04</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      使用webpack4提升180%编译速度
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
	<div class="article-tag tagcloud">
		<ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Tool/" rel="tag">Tool</a></li></ul>
	</div>

        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
          <span class="toc-arrow"></span>
<div id="toc" class="toc-article">
    <div class="toc-title">目录</div>
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%A9%E4%B8%8B%E6%AD%A6%E5%8A%9F%EF%BC%8C%E5%94%AF%E5%BF%AB%E4%B8%8D%E7%A0%B4"><span class="toc-text">天下武功，唯快不破</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E7%89%B9%E6%80%A7"><span class="toc-text">新特性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E4%B8%8A%E8%BD%A6%EF%BC%8C%E5%8D%87%E7%BA%A7%E5%89%8D%E7%9A%84%E5%87%86%E5%A4%87"><span class="toc-text">快上车，升级前的准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%87%E7%BA%A7%E9%81%BF%E5%9D%91%E6%8C%87%E5%8D%97"><span class="toc-text">升级避坑指南</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%81%E7%BB%AD%E5%8A%A0%E9%80%9F"><span class="toc-text">持续加速</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E7%BB%93%E6%9E%9C%E5%88%86%E6%9E%90"><span class="toc-text">编译结果分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%A2%E5%90%91tree-shaking%EF%BC%8C%E7%BA%A6%E6%9D%9F%E7%BC%96%E7%A0%81"><span class="toc-text">面向tree-shaking，约束编码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E5%B0%BE"><span class="toc-text">结尾</span></a></li></ol>
</div>
      
        <p>对于现在的前端项目而言，编译发布几乎是必需操作，有的编译只需要几秒钟，快如闪电，有的却需要10分钟，甚至更多，慢如蜗牛。特别是线上热修复时，分秒必争，响应速度直接影响了用户体验，用户不会有耐心等那么长时间，让你慢慢编译；如果涉及到支付操作，产品损失更是以秒计，每提前哪怕一秒钟发布，在腾讯海量用户面前，都能挽回不小的损失。不仅如此，编译效率的提升，带来的最直观收益就是，开发效率与开发体验双重提升。</p>
<p>那么，到底是什么拖慢了webpack打包效率，我们又能做哪些提升呢？</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-logo.gif" alt="webpack"></p>
<a id="more"></a>
<p>webpack 是目前非常受欢迎的打包工具，截止6天前，webpack4 已更新至 <code>4.28.3</code> 版本，10 个月的时间，小版本更新达几十次之多，可见社区之繁荣。</p>
<p>webpack4 发布时，官方也曾表示，其编译速度提升了 60% ~ 98%。</p>
<h3 id="天下武功，唯快不破"><a href="#天下武功，唯快不破" class="headerlink" title="天下武功，唯快不破"></a><strong>天下武功，唯快不破</strong></h3><p>由于本地项目升级到 webpack4 有几个月了，为了获得测试数据，手动将 webpack 降级为 3.12.0 版本，其它配置基本不做改动。</p>
<p>测试时，Mac仅运行常用的IM、邮箱、终端、浏览器等，为了尽可能避免插件对数据的影响，我关闭了一些优化插件，只保留常用的loader、js压缩插件。</p>
<p>以下是分别在 webpack@3.12.0 及 webpack@4.26.1 两种场景下各测 5 次的运行截图。</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-0-happyPack-0-dll-0-parallel.3~4.png" alt="webpack3~4x编译速度对比"></p>
<p>数据分析如下（单位ms）：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">第1次</th>
<th style="text-align:center">第2次</th>
<th style="text-align:center">第3次</th>
<th style="text-align:center">第4次</th>
<th style="text-align:center">第5次</th>
<th style="text-align:center">平均</th>
<th style="text-align:center">速度提升</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">webpack3</td>
<td style="text-align:center">58293</td>
<td style="text-align:center">60971</td>
<td style="text-align:center">57263</td>
<td style="text-align:center">58993</td>
<td style="text-align:center">60459</td>
<td style="text-align:center">59195.8</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">webpack4</td>
<td style="text-align:center">42346</td>
<td style="text-align:center">40386</td>
<td style="text-align:center">40138</td>
<td style="text-align:center">40330</td>
<td style="text-align:center">40323</td>
<td style="text-align:center">40704.6</td>
<td style="text-align:center">45%</td>
</tr>
</tbody>
</table>
<p>纯粹的版本升级，编译速度提升为 <code>45%</code>，这里我选取的是成熟的线上运行项目，构建速度的提升只有建立在成熟项目上才有意义，demo 项目由于编译文件基数小，难以体现出构建环境的复杂性，测试时也可能存在较大误差。同时与官方数据的差距，主要是因为基于的项目及配置不同。</p>
<p>无论如何，近 50% 的编译速度提升，都值得你尝试升级 webpack4！当然，优化才刚刚开始，请继续往下读。</p>
<h3 id="新特性"><a href="#新特性" class="headerlink" title="新特性"></a><strong>新特性</strong></h3><p>为了更流畅的升级 webpack4，我们先要了解它。</p>
<p>webpack4 在大幅度提升编译效率同时，引入了多种新特性：</p>
<ol>
<li><p>受 Parcel 启发，支持 0 配置启动项目，不再强制需要 webpack.config.js 配置文件，默认入口 <code>./src/</code> 目录，默认entry <code>./src/index.js</code> ，默认输出 <code>./dist</code> 目录，默认输出文件 <code>./dist/main.js</code>。</p>
</li>
<li><p>开箱即用 WebAssembly，webpack4提供了wasm的支持，现在可以引入和导出任何一个 Webassembly 的模块，也可以写一个loader来引入C++、C和Rust。（注：WebAssembly 模块只能在异步chunks中使用）</p>
</li>
<li><p>提供mode属性，设置为 <code>development</code> 将获得最好的开发体验，设置为 <code>production</code>  将专注项目编译部署，比如说开启 Scope hoisting 和 Tree-shaking 功能。</p>
</li>
<li><p>全新的插件系统，提供了针对插件和钩子的新API，变化如下：</p>
<ul>
<li>所有的 hook 由 hooks 对象统一管理，它将所有的hook作为可扩展的类属性</li>
<li>添加插件时，你需要提供一个名字</li>
<li>开发插件时，你可以选择插件的类型（sync/callback/promise之一）</li>
<li>通过 this.hooks = { myHook: new SyncHook(…) } 来注册hook</li>
</ul>
<p>更多插件的工作原理，可以参考：<a href="https://medium.com/webpack/the-new-plugin-system-week-22-23-c24e3b22e95" target="_blank" rel="external">新插件系统如何工作</a>。</p>
</li>
</ol>
<h3 id="快上车，升级前的准备"><a href="#快上车，升级前的准备" class="headerlink" title="快上车，升级前的准备"></a><strong>快上车，升级前的准备</strong></h3><p>首先，webpack-dev-server 插件需要升级至最新，同时，由于webpack-cli 承担了webpack4 命令行相关的功能，因此 webpack-cli 也是必需的。</p>
<p>与以往不同的是，mode属性必须指定，否则按照 <code>约定优于配置</code> 原则，将默认按照 <code>production</code> 生产环境编译，如下是警告原文。</p>
<blockquote>
<p>WARNING in configuration<br>The ‘mode’ option has not been set, webpack will fallback to ‘production’ for this value. Set ‘mode’ option to ‘development’ or ‘production’ to enable defaults for each environment.<br>You can also set it to ‘none’ to disable any default behavior. Learn more: <a href="https://webpack.js.org/concepts/mode/" target="_blank" rel="external">https://webpack.js.org/concepts/mode/</a></p>
</blockquote>
<p>有两种方式可以加入mode配置。</p>
<ul>
<li><p>在package.json script中指定–mode：</p>
<pre><code class="js">&quot;scripts&quot;: {
    &quot;dev&quot;: &quot;webpack-dev-server --mode development --inline --progress --config build/webpack.dev.config.js&quot;,
    &quot;build&quot;: &quot;webpack --mode production --progress --config build/webpack.prod.config.js&quot;
}
</code></pre>
</li>
<li><p>在配置文件中加入mode属性</p>
<pre><code class="js">module.exports = {
  mode: &#39;production&#39; // 或 development
};
</code></pre>
</li>
</ul>
<p>升级至webpack4后，一些默认插件由 optimization 配置替代了，如下：</p>
<ul>
<li>CommonsChunkPlugin废弃，由 optimization.splitChunks 和 optimization.runtimeChunk 替代，前者拆分代码，后者提取runtime代码。原来的CommonsChunkPlugin产出模块时，会包含重复的代码，并且无法优化异步模块，minchunks的配置也较复杂，splitChunks解决了这个问题；另外，将 optimization.runtimeChunk 设置为true（或{name: “manifest”}），便能将入口模块中的runtime部分提取出来。</li>
<li>NoEmitOnErrorsPlugin 废弃，由 optimization.noEmitOnErrors 替代，生产环境默认开启。</li>
<li>NamedModulesPlugin 废弃，由 optimization.namedModules 替代，生产环境默认开启。</li>
<li>ModuleConcatenationPlugin 废弃，由 optimization.concatenateModules 替代，生产环境默认开启。</li>
<li>optimize.UglifyJsPlugin 废弃，由 optimization.minimize 替代，生产环境默认开启。</li>
</ul>
<p>不仅如此，optimization 还提供了如下默认配置：</p>
<pre><code class="js">optimization: {
    minimize: env === &#39;production&#39; ? true : false, // 开发环境不压缩
    splitChunks: {
        chunks: &quot;async&quot;, // 共有三个值可选：initial(初始模块)、async(按需加载模块)和all(全部模块)
        minSize: 30000, // 模块超过30k自动被抽离成公共模块
        minChunks: 1, // 模块被引用&gt;=1次，便分割
        maxAsyncRequests: 5,  // 异步加载chunk的并发请求数量&lt;=5
        maxInitialRequests: 3, // 一个入口并发加载的chunk数量&lt;=3
        name: true, // 默认由模块名+hash命名，名称相同时多个模块将合并为1个，可以设置为function
        automaticNameDelimiter: &#39;~&#39;, // 命名分隔符
        cacheGroups: { // 缓存组，会继承和覆盖splitChunks的配置
            default: { // 模块缓存规则，设置为false，默认缓存组将禁用
                minChunks: 2, // 模块被引用&gt;=2次，拆分至vendors公共模块
                priority: -20, // 优先级
                reuseExistingChunk: true, // 默认使用已有的模块
            },
            vendors: {
                test: /[\\/]node_modules[\\/]/, // 表示默认拆分node_modules中的模块
                priority: -10
            }
        }
    }
}
</code></pre>
<p>splitChunks是拆包优化的重点，如果你的项目中包含 element-ui 等第三方组件（组件较大），建议单独拆包，如下所示。</p>
<pre><code class="js">splitChunks: {
    // ...
    cacheGroups: {    
        elementUI: {
            name: &quot;chunk-elementUI&quot;, // 单独将 elementUI 拆包
            priority: 15, // 权重需大于其它缓存组
            test: /[\/]node_modules[\/]element-ui[\/]/
        }
    }
}
</code></pre>
<p>其更多用法，请参考以上注释或官方文档 <a href="https://webpack.js.org/plugins/split-chunks-plugin/" target="_blank" rel="external">SplitChunksPlugin</a>。</p>
<h3 id="升级避坑指南"><a href="#升级避坑指南" class="headerlink" title="升级避坑指南"></a><strong>升级避坑指南</strong></h3><blockquote>
<p>webpack4不再支持Node 4，由于使用了JavaScript新语法，Webpack的创始人之一，Tobias，建议用户使用Node版本 &gt;= 8.94，以便使用最优性能。</p>
</blockquote>
<p>正式升级后，你可能会遇到各种各样的错误，其中，下面一些问题较为常见。</p>
<p>vue-loader v15 需要在 webpack 中添加 VueLoaderPlugin 插件，参考如下。</p>
<pre><code class="js">const { VueLoaderPlugin } = require(&quot;vue-loader&quot;); // const VueLoaderPlugin = require(&quot;vue-loader/lib/plugin&quot;); // 两者等同

//...
plugins: [
  new VueLoaderPlugin()
]
</code></pre>
<p>升级到 webpack4 后，mini-css-extract-plugin 替代 extract-text-webpack-plugin 成为css打包首选，相比之前，它有如下优势：</p>
<ol>
<li>异步加载</li>
<li>不重复编译，性能更好</li>
<li>更容易使用</li>
</ol>
<p>缺陷，不支持css热更新。因此需在开发环境引入 css-hot-loader，以便支持css热更新，如下所示：</p>
<pre><code class="js">{
    test: /\.scss$/,
    use: [
        ...(isDev ? [&quot;css-hot-loader&quot;, &quot;style-loader&quot;] : [MiniCssExtractPlugin.loader]),
        &quot;css-loader&quot;,
        postcss,
        &quot;sass-loader&quot;
    ]
}
</code></pre>
<p>发布到生产环境之前，css是需要优化压缩的，使用 optimize-css-assets-webpack-plugin 插件即可，如下。</p>
<pre><code class="js">const OptimizeCssAssetsPlugin = require(&#39;optimize-css-assets-webpack-plugin&#39;);

//...
plugins: [
    new OptimizeCssAssetsPlugin({
        cssProcessor: cssnano,
        cssProcessorOptions: {
            discardComments: {
                removeAll: true
            }
        }
    })
]
</code></pre>
<h3 id="持续加速"><a href="#持续加速" class="headerlink" title="持续加速"></a><strong>持续加速</strong></h3><p>文章开始，我曾提到，优化才刚刚开始。是的，随着项目越来越复杂，webpack也随之变慢，一定有办法可以进一步压榨性能。</p>
<p>经过很长一段时间的多个项目运行以及测试，以下几点经验<strong>非常有效</strong>。</p>
<ol>
<li><p>缩小编译范围，减少不必要的编译工作，即 modules、mainFields、noParse、includes、exclude、alias全部用起来。</p>
<pre><code class="js">const resolve = dir =&gt; path.join(__dirname, &#39;..&#39;, dir);

// ...
resolve: {
    modules: [ // 指定以下目录寻找第三方模块，避免webpack往父级目录递归搜索
        resolve(&#39;src&#39;),
        resolve(&#39;node_modules&#39;),
        resolve(config.common.layoutPath)
    ],
    mainFields: [&#39;main&#39;], // 只采用main字段作为入口文件描述字段，减少搜索步骤
    alias: {
        vue$: &quot;vue/dist/vue.common&quot;,
        &quot;@&quot;: resolve(&quot;src&quot;) // 缓存src目录为@符号，避免重复寻址
    }
},
module: {
    noParse: /jquery|lodash/, // 忽略未采用模块化的文件，因此jquery或lodash将不会被下面的loaders解析
    // noParse: function(content) {
    //     return /jquery|lodash/.test(content)
    // },
    rules: [
        {
            test: /\.js$/,
            include: [ // 表示只解析以下目录，减少loader处理范围
                resolve(&quot;src&quot;),
                resolve(config.common.layoutPath)
            ],
            exclude: file =&gt; /test/.test(file), // 排除test目录文件
            loader: &quot;happypack/loader?id=happy-babel&quot; // 后面会介绍
        },
    ]
}
</code></pre>
</li>
<li><p>想要进一步提升编译速度，就要知道瓶颈在哪？通过测试，发现有两个阶段较慢：① babel 等 loaders 解析阶段；② js 压缩阶段。loader 解析稍后会讨论，而 js 压缩是发布编译的最后阶段，通常webpack需要卡好一会，这是因为压缩 JS 需要先将代码解析成 AST 语法树，然后需要根据复杂的规则去分析和处理 AST，最后将 AST 还原成 JS，这个过程涉及到大量计算，因此比较耗时。如下图，编译就看似卡住。</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-ParallelUglify.png" alt="ParallelUglify"></p>
<p>实际上，搭载 webpack-parallel-uglify-plugin 插件，这个过程可以倍速提升。我们都知道 node 是单线程的，但node能够fork子进程，基于此，webpack-parallel-uglify-plugin 能够把任务分解给多个子进程去并发的执行，子进程处理完后再把结果发送给主进程，从而实现并发编译，进而大幅提升js压缩速度，如下是配置。</p>
<pre><code class="js">const ParallelUglifyPlugin = require(&#39;webpack-parallel-uglify-plugin&#39;);

// ...
optimization: {
    minimizer: [
        new ParallelUglifyPlugin({ // 多进程压缩
            cacheDir: &#39;.cache/&#39;,
            uglifyJS: {
                output: {
                    comments: false,
                    beautify: false
                },
                compress: {
                    warnings: false,
                    drop_console: true,
                    collapse_vars: true,
                    reduce_vars: true
                }
            }
        }),
    ]
}
</code></pre>
<p>当然，我分别测试了五组数据，如下是截图：</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-0-happyPack-0-dll-1-parallel.3~4.png" alt="ParallelUglifyPlugin插件启用后编译速度分析"></p>
<p>数据分析如下（单位ms）：</p>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">第1次</th>
<th style="text-align:center">第2次</th>
<th style="text-align:center">第3次</th>
<th style="text-align:center">第4次</th>
<th style="text-align:center">第5次</th>
<th style="text-align:center">平均</th>
<th style="text-align:center">速度提升</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">webpack3</td>
<td style="text-align:center">58293</td>
<td style="text-align:center">60971</td>
<td style="text-align:center">57263</td>
<td style="text-align:center">58993</td>
<td style="text-align:center">60459</td>
<td style="text-align:center">59195.8</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">webpack3搭载ParallelUglifyPlugin插件</td>
<td style="text-align:center">44380</td>
<td style="text-align:center">39969</td>
<td style="text-align:center">39694</td>
<td style="text-align:center">39344</td>
<td style="text-align:center">39295</td>
<td style="text-align:center">40536.4</td>
<td style="text-align:center">46%</td>
</tr>
<tr>
<td style="text-align:center">webpack4</td>
<td style="text-align:center">42346</td>
<td style="text-align:center">40386</td>
<td style="text-align:center">40138</td>
<td style="text-align:center">40330</td>
<td style="text-align:center">40323</td>
<td style="text-align:center">40704.6</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">webpack4搭载ParallelUglifyPlugin插件</td>
<td style="text-align:center">31134</td>
<td style="text-align:center">29554</td>
<td style="text-align:center">31883</td>
<td style="text-align:center">29198</td>
<td style="text-align:center">29072</td>
<td style="text-align:center">30168.2</td>
<td style="text-align:center">35%</td>
</tr>
</tbody>
</table>
<p>   搭载 webpack-parallel-uglify-plugin 插件后，webpack3 的构建速度能够提升 46%；即使升级到 webpack4 后，构建速度依然能够进一步提升 35%。</p>
<ol>
<li><p>现在我们来看看，loader 解析速度如何提升。同 webpack-parallel-uglify-plugin 插件一样，HappyPack 也能实现并发编译，从而可以大幅提升 loader 的解析速度， 如下是部分配置。</p>
<pre><code class="js">const HappyPack = require(&#39;happypack&#39;);
const happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length });
const createHappyPlugin = (id, loaders) =&gt; new HappyPack({
    id: id,
    loaders: loaders,
    threadPool: happyThreadPool,
    verbose: process.env.HAPPY_VERBOSE === &#39;1&#39; // make happy more verbose with HAPPY_VERBOSE=1
});
</code></pre>
<p>那么，对于前面 <code>loader: &quot;happypack/loader?id=happy-babel&quot;</code> 这句，便需要在 plugins 中创建一个 <code>happy-babel</code> 的插件实例。</p>
<pre><code class="js">plugins: [
    createHappyPlugin(&#39;happy-babel&#39;, [{
        loader: &#39;babel-loader&#39;,
        options: {
            babelrc: true,
            cacheDirectory: true // 启用缓存
        }
    }])
]
</code></pre>
<p>如下，happyPack开启了3个进程（默认为CPU数-1），运行过程感受下。</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-happyPack.gif" alt="happyPack"></p>
<p>另外，像 vue-loader、css-loader 都支持 happyPack 加速，如下所示。</p>
<pre><code class="json">plugins: [
    createHappyPlugin(&#39;happy-css&#39;, [&#39;css-loader&#39;, &#39;vue-style-loader&#39;]),
    new HappyPack({
        loaders: [{
            path: &#39;vue-loader&#39;,
            query: {
                loaders: {
                    scss: &#39;vue-style-loader!css-loader!postcss-loader!sass-loader?indentedSyntax&#39;
                }
            }
        }]
    })
]
</code></pre>
<p>基于 webpack4，搭载 webpack-parallel-uglify-plugin 和 happyPack 插件，测试截图如下：</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-1-happyPack-0-dll-1-parallel.w4.png" alt="搭载两款插件后编译速度分析"></p>
<p>数据分析如下（单位ms）：</p>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">第1次</th>
<th style="text-align:center">第2次</th>
<th style="text-align:center">第3次</th>
<th style="text-align:center">第4次</th>
<th style="text-align:center">第5次</th>
<th style="text-align:center">平均</th>
<th style="text-align:center">速度提升</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">仅搭载ParallelUglifyPlugin</td>
<td style="text-align:center">31134</td>
<td style="text-align:center">29554</td>
<td style="text-align:center">31883</td>
<td style="text-align:center">29198</td>
<td style="text-align:center">29072</td>
<td style="text-align:center">30168.2</td>
<td style="text-align:center">35%</td>
</tr>
<tr>
<td style="text-align:center">搭载ParallelUglifyPlugin 和 happyPack</td>
<td style="text-align:center">26036</td>
<td style="text-align:center">25884</td>
<td style="text-align:center">25645</td>
<td style="text-align:center">25627</td>
<td style="text-align:center">25794</td>
<td style="text-align:center">25797.2</td>
<td style="text-align:center">17%</td>
</tr>
</tbody>
</table>
<p>   可见，在搭载 webpack-parallel-uglify-plugin 插件的基础上，happyPack 插件依然能够提升 17% 的编译速度，实际上由于 sass 等 loaders 不支持 happyPack，happyPack 的性能依然有提升空间。更多介绍不妨参考 <a href="http://taobaofed.org/blog/2016/12/08/happypack-source-code-analysis/" target="_blank" rel="external">happypack 原理解析</a>。</p>
<ol>
<li><p>我们都知道，webpack打包时，有一些框架代码是基本不变的，比如说 babel-polyfill、vue、vue-router、vuex、axios、element-ui、fastclick 等，这些模块也有不小的 size，每次编译都要加载一遍，比较费时费力。使用 DLLPlugin 和 DLLReferencePlugin 插件，便可以将这些模块提前打包。</p>
<p>为了完成 dll 过程，我们需要准备一份新的webpack配置，即 webpack.dll.config.js。</p>
<pre><code class="js">const webpack = require(&quot;webpack&quot;);
const path = require(&#39;path&#39;);
const CleanWebpackPlugin = require(&quot;clean-webpack-plugin&quot;);
const dllPath = path.resolve(__dirname, &quot;../src/assets/dll&quot;); // dll文件存放的目录

module.exports = {
    entry: {
        // 把 vue 相关模块的放到一个单独的动态链接库
        vue: [&quot;babel-polyfill&quot;, &quot;fastclick&quot;, &quot;vue&quot;, &quot;vue-router&quot;, &quot;vuex&quot;, &quot;axios&quot;, &quot;element-ui&quot;]
    },
    output: {
        filename: &quot;[name]-[hash].dll.js&quot;, // 生成vue.dll.js
        path: dllPath,
        library: &quot;_dll_[name]&quot;
    },
    plugins: [
        new CleanWebpackPlugin([&quot;*.js&quot;], { // 清除之前的dll文件
            root: dllPath,
        }),
        new webpack.DllPlugin({
            name: &quot;_dll_[name]&quot;,
            // manifest.json 描述动态链接库包含了哪些内容
            path: path.join(__dirname, &quot;./&quot;, &quot;[name].dll.manifest.json&quot;)
        }),
    ],
};
</code></pre>
<p>接着， 需要在 package.json 中新增 dll 命令。</p>
<pre><code class="json">&quot;scripts&quot;: {
    &quot;dll&quot;: &quot;webpack --mode production --config build/webpack.dll.config.js&quot;
}
</code></pre>
<p>运行 <code>npm run dll</code> 后，会生成 <code>./src/assets/dll/vue.dll-[hash].js</code> 公共js 和 <code>./build/vue.dll.manifest.json</code> 资源说明文件，至此 dll 准备工作完成，接下来在 webpack 中引用即可。</p>
<pre><code class="js">externals: {
    &#39;vue&#39;: &#39;Vue&#39;,
    &#39;vue-router&#39;: &#39;VueRouter&#39;,
    &#39;vuex&#39;: &#39;vuex&#39;,
    &#39;elemenct-ui&#39;: &#39;ELEMENT&#39;,
    &#39;axios&#39;: &#39;axios&#39;,
    &#39;fastclick&#39;: &#39;FastClick&#39;
},
plugins: [
    ...(config.common.needDll ? [
        new webpack.DllReferencePlugin({
            manifest: require(&quot;./vue.dll.manifest.json&quot;)
        })
    ] : [])
]
</code></pre>
<p>dll 公共js轻易不会变化，假如在将来真的发生了更新，那么新的dll文件名便需要加上新的hash，从而避免浏览器缓存老的文件，造成执行出错。由于 hash 的不确定性，我们在 html 入口文件中没办法指定一个固定链接的 script 脚本，刚好，add-asset-html-webpack-plugin 插件可以帮我们自动引入 dll 文件。</p>
<pre><code class="js">const autoAddDllRes = () =&gt; {
    const AddAssetHtmlPlugin = require(&#39;add-asset-html-webpack-plugin&#39;);
    return new AddAssetHtmlPlugin([{ // 往html中注入dll js
        publicPath: config.common.publicPath + &quot;dll/&quot;,  // 注入到html中的路径
        outputPath: &quot;dll&quot;, // 最终输出的目录
        filepath: resolve(&quot;src/assets/dll/*.js&quot;),
        includeSourcemap: false,
        typeOfAsset: &quot;js&quot; // options js、css; default js
    }]);
};

// ...
plugins: [
    ...(config.common.needDll ? [autoAddDllRes()] : [])
]
</code></pre>
<p>搭载 dll 插件后，webpack4 编译速度进一步提升，如下截图：</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-1-happyPack-1-dll-1-parallel.w4.png" alt="搭载三款插件后编译速度分析"></p>
<p>数据分析如下（单位ms）：</p>
</li>
</ol>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">第1次</th>
<th style="text-align:center">第2次</th>
<th style="text-align:center">第3次</th>
<th style="text-align:center">第4次</th>
<th style="text-align:center">第5次</th>
<th style="text-align:center">平均</th>
<th style="text-align:center">速度提升</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">搭载ParallelUglifyPlugin 和 happyPack</td>
<td style="text-align:center">26036</td>
<td style="text-align:center">25884</td>
<td style="text-align:center">25645</td>
<td style="text-align:center">25627</td>
<td style="text-align:center">25794</td>
<td style="text-align:center">25797.2</td>
<td style="text-align:center">17%</td>
</tr>
<tr>
<td style="text-align:center">搭载ParallelUglifyPlugin 、happyPack 和 dll</td>
<td style="text-align:center">20792</td>
<td style="text-align:center">20963</td>
<td style="text-align:center">20845</td>
<td style="text-align:center">21675</td>
<td style="text-align:center">21023</td>
<td style="text-align:center">21059.6</td>
<td style="text-align:center">22%</td>
</tr>
</tbody>
</table>
<p>   可见，搭载 dll 后，webpack4 编译速度仍能提升 22%。</p>
<p>   综上，我们汇总上面的多次数据，得到下表：</p>
<table>
<thead>
<tr>
<th style="text-align:center"></th>
<th style="text-align:center">第1次</th>
<th style="text-align:center">第2次</th>
<th style="text-align:center">第3次</th>
<th style="text-align:center">第4次</th>
<th style="text-align:center">第5次</th>
<th style="text-align:center">平均</th>
<th style="text-align:center">速度提升</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">webpack3</td>
<td style="text-align:center">58293</td>
<td style="text-align:center">60971</td>
<td style="text-align:center">57263</td>
<td style="text-align:center">58993</td>
<td style="text-align:center">60459</td>
<td style="text-align:center">59195.8</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">webpack4</td>
<td style="text-align:center">42346</td>
<td style="text-align:center">40386</td>
<td style="text-align:center">40138</td>
<td style="text-align:center">40330</td>
<td style="text-align:center">40323</td>
<td style="text-align:center">40704.6</td>
<td style="text-align:center">45%</td>
</tr>
<tr>
<td style="text-align:center">搭载ParallelUglifyPlugin 、happyPack 和 dll</td>
<td style="text-align:center">20792</td>
<td style="text-align:center">20963</td>
<td style="text-align:center">20845</td>
<td style="text-align:center">21675</td>
<td style="text-align:center">21023</td>
<td style="text-align:center">21059.6</td>
<td style="text-align:center">181%</td>
</tr>
</tbody>
</table>
<p>   升级至 webpack4 后，通过搭载 ParallelUglifyPlugin 、happyPack 和 dll 插件，编译速度可以提升181%，整体编译时间减少了将近 2/3，为开发节省了大量编译时间！而且随着项目发展，这种编译提升越来越可观。</p>
<p>   实际上，为了获得上面的测试数据，我关闭了 babel、ParallelUglifyPlugin 的缓存，开启缓存后，第二次编译时间平均为 12.8s，由于之前缓存过，编译速度相对 webpack3 将提升362%，即使你已经升级到 webpack4，搭载上述 3 款插件后，编译速度仍能获得 218% 的提升！</p>
<h3 id="编译结果分析"><a href="#编译结果分析" class="headerlink" title="编译结果分析"></a><strong>编译结果分析</strong></h3><p>当然，编译速度作为一项指标，影响的更多是开发者体验，与之相比，编译后文件大小更为重要。webpack4 编译的文件，比之前版本略小一些，为了更好的追踪文件 size 变化，开发环境和生产环境都需要引入 webpack-bundle-analyzer 插件，如下图。</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-analyzer.png" alt="analyzer"></p>
<p>文件 size 如下图所示：</p>
<p><img src="http://louiszhai.github.io/docImages/webpack-analyzer.size.png" alt="analyzer.size"></p>
<h3 id="面向tree-shaking，约束编码"><a href="#面向tree-shaking，约束编码" class="headerlink" title="面向tree-shaking，约束编码"></a><strong>面向tree-shaking，约束编码</strong></h3><p><strong>sideEffects</strong></p>
<p>从 webpack2 开始，tree-shaking 便用来消除无用模块，依赖的是 ES Module 的静态结构，同时通过在. babelrc 文件中设置 <code>&quot;modules&quot;: false</code> 来开启无用的模块检测，相对粗暴。webapck4 灵活扩展了无用代码检测方式，主要通过在 <code>package.json</code> 文件中设置 <code>sideEffects: false</code> 来告诉编译器该项目或模块是 pure 的，可以进行无用模块删除，因此，开发公共组件时，可以尝试设置下。</p>
<p>为了使得 tree-shaking 真正生效，引入资源时，仅仅引入需要的组件尤为重要，如下所示：</p>
<pre><code class="js">import { Button, Input } from &quot;element-ui&quot;; // 只引入需要的组件
</code></pre>
<h3 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a><strong>结尾</strong></h3><p>升级 webpack4 的过程，踩坑是必须的，关键是踩坑后，你能得到什么？</p>
<p>另外，除了文中介绍的一些优化方法，更多的优化策略，正在逐步验证中…</p>

      
    </div>
    
  </div>
  
  
    <! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
       支持一杯咖啡吧！
        </span>
      </div>  
  <div id="donate_guide" class="donate_bar center hidden" >
    <!-- 支付宝打赏图案 -->
    <img src="/img/alipay.gif" alt="支付宝打赏"> 
    <!-- 微信打赏图案 -->
    <img src="/img/weixin.gif" alt="微信打赏">  
    </div>
  <script type="text/javascript">
    document.getElementById('btn_donate').onclick = function(){
      $('#donate_board').addClass('hidden');
      $('#donate_guide').removeClass('hidden');
    }
  </script>
</div>
<! -- 添加捐赠图标 -->
  

  
    
<nav id="article-nav">
  
    <a href="/2019/12/02/webpack4.ie/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption"><</strong>
      <div class="article-nav-title">
        
          webpack4编译代码如何完美适配IE内核
        
      </div>
    </a>
  
  
    <a href="/2018/05/31/alfred/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">Alfred神器使用手册</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share_jia">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">Share to: &nbsp; </span>
		<a class="jiathis_button_facebook"></a> 
    <a class="jiathis_button_twitter"></a>
    <a class="jiathis_button_plus"></a> 
    <a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>










  <style>
/*
    Name:     Kimbie (light)
    Author:   Jan T. Sott
    License:  Creative Commons Attribution-ShareAlike 4.0 Unported License
    URL:      https://github.com/idleberg/Kimbie-highlight.js
*/

/* Kimbie Comment */
.hljs-comment,
.hljs-quote {
  color: #a57a4c;
}

/* Kimbie Red */
.hljs-variable,
.hljs-template-variable,
.hljs-tag,
.hljs-name,
.hljs-selector-id,
.hljs-selector-class,
.hljs-regexp,
.hljs-meta {
  color: #dc3958;
}

/* Kimbie Orange */
.hljs-number,
.hljs-built_in,
.hljs-builtin-name,
.hljs-literal,
.hljs-type,
.hljs-params,
.hljs-deletion,
.hljs-link {
  color: #f79a32;
}

/* Kimbie Yellow */
.hljs-title,
.hljs-section,
.hljs-attribute {
  color: #f06431;
}

/* Kimbie Green */
.hljs-string,
.hljs-symbol,
.hljs-bullet,
.hljs-addition {
  color: #889b4a;
}

/* Kimbie Purple */
.hljs-keyword,
.hljs-selector-tag,
.hljs-function {
  color: #98676a;
}

.hljs {
  display: block;
  overflow-x: auto;
  /*background: #fbebd4;*/
  color: #84613d;
  padding: 0.5em;
}

.hljs-emphasis {
  font-style: italic;
}

.hljs-strong {
  font-weight: bold;
}
</style>
  <script src="//cdn.bootcss.com/highlight.js/9.2.0/highlight.min.js"></script>
  <script>
    // hljs.initHighlightingOnLoad();
    [].slice.call(document.querySelectorAll('pre code')).forEach(function(block, i) {
      hljs.highlightBlock(block);
      var lines = block.innerText.split('\n').length - 1;
      var ul = document.createElement('ul');
      ul.className = 'pre-numbering';
      block.className += ' has-numbering';
      block.parentNode.appendChild(ul);
      for(i=1;i<=lines;i++){
        var li = document.createElement('li');
        li.innerText = i;
        ul.appendChild(li);
      }
    });
  </script>
</div>
        <link rel="stylesheet" href="/css/content.css" type="text/css">
<footer id="footer">
  <div class="outer">
    <div id="footer-info">
      <img src="/img/top_arrow.png" class="top_arrow" id="top_arrow">
    	<div class="footer-left">
    		&copy; 2023 路易斯

        <span style="position:relative;top:2px" id="cnzz_stat_icon_1256923583"></span>
        <script type="text/javascript">
          var s = document.createElement('script');
          var cnzz_protocol = (("https:" == document.location.protocol) ? "https://" : "http://");
          s.src = cnzz_protocol + "s11.cnzz.com/z_stat.php?id=1256923583&show=pic";
          document.body.appendChild(s);
        </script>

    	</div>
      	<div class="footer-right">
      		<a href="https://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
<script type="text/javascript">
  //swifty
  /*(function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','4AmBuvmx4Cy-3hvyxeh8','2.0.0');*/
</script>
    </div>
    
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">



<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: false,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>

<script src="/js/jquery-1.9.1.min.js"></script>


<script src="/js/main.js"></script>


<script src="/js/content.js"></script>








</div>

<script src="/js/screenfull.js"></script>

<a target="_blank" rel="noopener" href="https://github.com/Louiszhai" style="position: fixed; top: 0; right: 0; border: 0;z-index:9999"><img
            source="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67"
            src="/img/fork_me_on_github.png" alt="Fork me on GitHub"
            data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a>
</body>
</html>